---

---
title: "Cod Inversions"
author: "KE Lotterhos"
date: "2024-03-18"
output: html_document
---

setwd("/Users/lotterhos/Library/CloudStorage/GoogleDrive-k.lotterhos@gmail.com/.shortcut-targets-by-id/1DPJy8RgFslz3_PSZLLl7Z21mCvQUvnJZ/Manuscripts/Cod Ecotypes GoM /data")

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("bigstatsr")
#install.packages("bigsnpr")
#install.packages("devtools")

#install.packages("vcfR")
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")

#BiocManager::install("qvalue", force=TRUE)
#devtools::install_github("whitlock/OutFLANK", force=TRUE)
```

load data
```{r}
library(devtools)
library(bigstatsr)
library(bigsnpr)
library(ggplot2)
library(OutFLANK)

bigSNP <- snp_attach(paste0("",  "acod_merged.MAF05_QC.rds"))

#  drop the individual at the 17th position because it is a duplicate. It was a fish that was right in the middle of being red or olive and it accidentally got left in both groups and got sequenced twice. 

G_full <- bigSNP$genotypes[-17,]
pos_full <- bigSNP$map$physical.pos
samp_full <- bigSNP$fam$sample.ID[-17]
pop_full <- bigSNP$fam$family.ID[-17]
chrom_full <- bigSNP$map$chromosome

unique(chrom_full)
dim(G_full)
NCORES <- nb_cores()

head(bigSNP$fam)
head(samp_full)
samp_full <- data.frame(samp_full)

samp_full$Pop <- bigSNP$fam$family.ID[-17]

```

# LG7

# Step 1: Subset data to the inversion on Chromosome 7. Identify inversion clusters.

```{r}
#ind7 <- which(chrom_full=="NC_044054.1")
#ind7_sub <- sort(sample(ind7, 10000))
#G7 <- G_full[,ind7_sub]

# Indices spanning up and downstream of the breakpoints
G7 <- G_full[,660728:699319]

# Recode for bigsnpr package tools
G7_snp <- add_code256(big_copy(G7,type="raw"),code=bigsnpr:::CODE_012) 

# PCA
svd7 <- big_randomSVD(G7_snp, 
                      snp_scaleBinom(), 
                      ncores = NCORES,
                      k=2)

plot(svd7, type = "scores") +
  aes(color = pop_full) +
  labs(color = "Population")

samp_full$LG7_PC1 <- svd7$u[,1]
samp_full$LG7_PC2 <- svd7$u[,2]

str(svd7)
head(svd7$u)
set.seed(2234677)
clust7 <- kmeans(svd7$u, 6, nstart=20)
str(clust7)
clust7$centers
table(clust7$cluster)

samp_full$LG7cluster <- as.character(unlist(clust7$cluster))

table(samp_full$LG7cluster, samp_full$Pop)

head(samp_full)

ggplot(samp_full) + geom_point(aes(x=LG7_PC1, y=LG7_PC2, col = LG7cluster)) + scale_colour_discrete()
```

```{r}
dim(G7)
heatmap((G7[,4000:8000]),
        scale="none",
        #Rowv = ,
        Colv = NA,
        labRow = samp_full$LG7cluster,
        cexRow = 0.3,
        cexCol=0.1)

heatmap((G7[which(samp_full$LG7cluster %in% c(4,1)),4000:8000]),
        scale="none",
        #Rowv = ,
        Colv = NA,
        labRow = samp_full$LG7cluster[which(samp_full$LG7cluster %in% c(4,1))],
        cexRow = 0.3,
        cexCol=0.1)
```


```{r}
# FST group 
library(OutFLANK)

# group 5 vs 6 is reference
# group 4 vs 1 is alternate
dim(G7)
my_fst <- MakeDiploidFSTMat(G7[which(samp_full$LG7cluster %in% c(4,1)),], 
                locusNames = 1:10000, 
                popNames = samp_full$LG7cluster[which(samp_full$LG7cluster %in% c(4,1))])
head(my_fst)
plot(my_fst$FST, pch=19, col=adjustcolor("blue",0.1))


my_fst <- MakeDiploidFSTMat(G7[which(samp_full$LG7cluster %in% c(5,6)),], 
                locusNames = 1:10000, 
                popNames = samp_full$LG7cluster[which(samp_full$LG7cluster %in% c(5,6))])
head(my_fst)
plot(my_fst$FST, pch=19, col=adjustcolor("orange",0.1))

my_fst <- MakeDiploidFSTMat(G7[which(samp_full$LG7cluster %in% c(5,1)),], 
                locusNames = 1:10000, 
                popNames = samp_full$LG7cluster[which(samp_full$LG7cluster %in% c(5,1))])
head(my_fst)
plot(my_fst$FST, pch=19, col=adjustcolor("magenta",0.1))

# Maine inversion 
my_fst <- MakeDiploidFSTMat(G7[which(samp_full$LG7cluster %in% c(6,1)),], 
                locusNames = 1:10000, 
                popNames = samp_full$LG7cluster[which(samp_full$LG7cluster %in% c(6,1))])
head(my_fst)
plot(my_fst$FST, pch=19, col=adjustcolor("green",0.1))
```

# LG7 goes between these indices
# confirm pattern
```{r}
G7 <- 
dim(G7)

G7_snp <- add_code256(big_copy(G7,type="raw"),code=bigsnpr:::CODE_012) 

svd7 <- big_randomSVD(G7_snp, 
                      snp_scaleBinom(), 
                      ncores = NCORES,
                      k=2)

plot(svd7$u[,1],svd7$u[,2])
```